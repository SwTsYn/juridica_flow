{% extends "base.html" %}{% set active='reports' %}
{% block content %}
<h1 class="text-xl font-semibold mb-4">Reportería</h1>

<!-- Toolbar -->
<div class="mb-4 flex items-center gap-2">
  <button id="btnExportPDF" class="bg-blue-600 text-white px-3 py-2 rounded">
    Exportar PDF
  </button>
</div>

<!-- Todo lo exportable -->
<div id="reportRoot">

  <!-- KPIs y vistas globales -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="bg-white rounded-2xl shadow p-4">
      <h2 class="font-semibold">Alertas inmediatas</h2>
      <p class="text-sm text-gray-500 mb-2">
        Requerimientos que vencen en 7 días o menos y siguen <strong>sin asignar</strong>.
      </p>
      <div class="text-3xl font-bold mt-1">{{ due_soon_unassigned }}</div>
    </div>

    <div class="bg-white rounded-2xl shadow p-4">
      <h2 class="font-semibold">Estado global</h2>
      <p class="text-sm text-gray-500 mb-2">
        Distribución total de requerimientos: sin asignar, pendientes y completados.
      </p>
      <canvas id="statusChart" height="120"></canvas>
    </div>

    <div class="bg-white rounded-2xl shadow p-4">
      <h2 class="font-semibold">Complejidad del trabajo</h2>
      <p class="text-sm text-gray-500 mb-2">
        Cuántos requerimientos hay por nivel de complejidad (1 baja, 2 media, 3 alta).
      </p>
      <canvas id="complexityChart" height="120"></canvas>
    </div>
  </div>

  <!-- Carga por usuario -->
  <div class="bg-white rounded-2xl shadow p-4 mb-6">
    <div class="flex items-start justify-between mb-2">
      <div>
        <h2 class="font-semibold">Distribución de carga por usuario</h2>
        <p class="text-sm text-gray-500">
          Tareas abiertas y atrasos por persona. La línea muestra el <em>puntaje total</em> (urgencia × complejidad × antigüedad).
        </p>
      </div>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div>
        <h3 class="text-sm font-medium mb-1">Abiertas / Atrasadas / Puntaje total</h3>
        <canvas id="userLoadChart" height="200"></canvas>
      </div>
      <div>
        <h3 class="text-sm font-medium mb-1">Distribución de puntajes por persona</h3>
        <p class="text-xs text-gray-500 mb-2">
          Bins de score: 0–0.33 (bajo), 0.34–0.66 (medio), 0.67–1.0 (alto).
        </p>
        <canvas id="userScoreBinsChart" height="200"></canvas>
      </div>
    </div>
  </div>

  <!-- Unidades requirentes -->
  <div class="bg-white rounded-2xl shadow p-4 mb-6">
    <h2 class="font-semibold">Unidades requirentes</h2>
    <p class="text-sm text-gray-500 mb-2">
      Totales, abiertas y atrasadas por unidad. La línea indica la <em>complejidad promedio</em> solicitada por cada unidad.
    </p>
    <canvas id="unitChart" height="220"></canvas>
  </div>

  <!-- Envejecimiento -->
  <div class="bg-white rounded-2xl shadow p-4 mb-6">
    <h2 class="font-semibold">Envejecimiento del backlog</h2>
    <p class="text-sm text-gray-500 mb-2">
      Antigüedad de los requerimientos desde su creación (0–7, 8–30, 31–60 y &gt;60 días).
    </p>
    <canvas id="agingChart" height="180"></canvas>
  </div>

</div> <!-- /#reportRoot -->

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

<script>
const userLabels = {{ user_labels | tojson }};
const userOpen = {{ user_open_counts | tojson }};
const userScore = {{ user_total_score | tojson }};
const userOverdue = {{ user_overdue_counts | tojson }};
const userBins1 = {{ user_bins_1 | tojson }};
const userBins2 = {{ user_bins_2 | tojson }};
const userBins3 = {{ user_bins_3 | tojson }};

const unitLabels = {{ unit_labels | tojson }};
const unitTotal = {{ unit_total_vals | tojson }};
const unitOpen = {{ unit_open_vals | tojson }};
const unitOverdue = {{ unit_overdue_vals | tojson }};
const unitAvgC = {{ unit_avg_complexity | tojson }};

const statusLabels = {{ status_labels | tojson }};
const statusVals = {{ status_vals | tojson }};

const compLabels = {{ complexity_labels | tojson }};
const compVals = {{ complexity_vals | tojson }};

const agingLabels = {{ aging_labels | tojson }};
const agingVals = {{ aging_vals | tojson }};

new Chart(document.getElementById('statusChart'), {
  type: 'doughnut',
  data: { labels: statusLabels, datasets: [{ data: statusVals }] },
  options: { plugins: { legend: { position: 'bottom' } } }
});

new Chart(document.getElementById('complexityChart'), {
  type: 'bar',
  data: { labels: compLabels, datasets: [{ label: 'Requerimientos', data: compVals }] },
  options: { scales: { y: { beginAtZero: true } } }
});

new Chart(document.getElementById('userLoadChart'), {
  type: 'bar',
  data: {
    labels: userLabels,
    datasets: [
      { label: 'Abiertas', data: userOpen },
      { label: 'Atrasadas', data: userOverdue },
      { label: 'Puntaje total', data: userScore, type: 'line', yAxisID: 'y1' }
    ]
  },
  options: {
    scales: {
      y: { beginAtZero: true, title: { display: true, text: 'Tareas' } },
      y1: { beginAtZero: true, position: 'right', title: { display: true, text: 'Puntaje' }, grid: { drawOnChartArea: false } }
    }
  }
});

new Chart(document.getElementById('userScoreBinsChart'), {
  type: 'bar',
  data: {
    labels: userLabels,
    datasets: [
      { label: '0-0.33', data: userBins1, stack: 'score' },
      { label: '0.34-0.66', data: userBins2, stack: 'score' },
      { label: '0.67-1.0', data: userBins3, stack: 'score' }
    ]
  },
  options: {
    scales: { y: { beginAtZero: true }, x: { stacked: true }, y: { stacked: true } }
  }
});

new Chart(document.getElementById('unitChart'), {
  type: 'bar',
  data: {
    labels: unitLabels,
    datasets: [
      { label: 'Totales', data: unitTotal },
      { label: 'Abiertas', data: unitOpen },
      { label: 'Atrasadas', data: unitOverdue },
      { label: 'Complejidad prom.', data: unitAvgC, type: 'line', yAxisID: 'y1' }
    ]
  },
  options: {
    scales: {
      y: { beginAtZero: true, title: { display: true, text: 'Requerimientos' } },
      y1: { beginAtZero: true, position: 'right', title: { display: true, text: 'Complejidad' }, grid: { drawOnChartArea: false }, suggestedMax: 3 }
    }
  }
});

new Chart(document.getElementById('agingChart'), {
  type: 'bar',
  data: { labels: agingLabels, datasets: [{ label: 'Requerimientos', data: agingVals }] },
  options: { scales: { y: { beginAtZero: true } } }
});
</script>

<!-- Librerías de exportación -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
// Utilidad para salto de página si no cabe el siguiente bloque
function ensureSpace(pdf, y, needed, margin) {
  const pageHeight = pdf.internal.pageSize.getHeight();
  if (y + needed > pageHeight - margin) {
    pdf.addPage();
    return margin; // reinicia y
  }
  return y;
}

document.getElementById('btnExportPDF').addEventListener('click', async () => {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p', 'mm', 'a4');
  const pageWidth = pdf.internal.pageSize.getWidth();
  const margin = 12;
  let y = margin;

  // Encabezado
  pdf.setFontSize(16);
  pdf.text('Reportería - Jurídica Flow', margin, y);
  y += 8;
  pdf.setFontSize(10);
  pdf.text(`Generado: ${new Date().toLocaleString()}`, margin, y);
  y += 6;

  // KPI principal como texto
  const kpi = '{{ due_soon_unassigned }}';
  pdf.setFontSize(11);
  pdf.text(`Alertas inmediatas (≤7 días y sin asignar): ${kpi}`, margin, y);
  y += 8;

  // Orden de inserción de gráficos
  const charts = [
    { id: 'statusChart', title: 'Estado global' },
    { id: 'complexityChart', title: 'Complejidad del trabajo' },
    { id: 'userLoadChart', title: 'Distribución de carga por usuario (abiertas/atrasadas + puntaje)' },
    { id: 'userScoreBinsChart', title: 'Distribución de puntajes por persona (bins)' },
    { id: 'unitChart', title: 'Unidades requirentes (totales/abiertas/atrasadas + complejidad promedio)' },
    { id: 'agingChart', title: 'Envejecimiento del backlog' },
  ];

  // Inserta cada canvas como imagen
  for (const { id, title } of charts) {
    const canvas = document.getElementById(id);
    if (!canvas) continue;

    // Título
    pdf.setFontSize(12);
    y = ensureSpace(pdf, y, 8, margin);
    pdf.text(title, margin, y);
    y += 4;

    // Imagen del canvas
    const imgData = canvas.toDataURL('image/png', 1.0);
    const canvasPxW = canvas.width;
    const canvasPxH = canvas.height;
    const imgW = pageWidth - margin * 2;
    const imgH = (canvasPxH / canvasPxW) * imgW;

    y = ensureSpace(pdf, y, imgH + 8, margin);
    pdf.addImage(imgData, 'PNG', margin, y, imgW, imgH, undefined, 'FAST');
    y += imgH + 6;
  }

  pdf.save(`reporteria_juridica_flow_${new Date().toISOString().slice(0,10)}.pdf`);
});
</script>
{% endblock %}
